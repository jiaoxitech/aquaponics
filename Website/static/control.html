<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Jiaoxi Aquaponics Lab</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="index.css" rel="stylesheet">

  </head>

  <body>
    <div class="container">
      <div class="page-header"><h1>Jiaoxi Aquaponics Lab<span class="pull-right"><a href="index.html" class="btn btn-primary btn-sm">Back</a></h1></div>
      <div class="login">
        <div class="alert alert-danger alertPW" role="alert" id="alertWrongPassword">Wrong password!</div>
        <form class="form-signin">
          <label for="inputPassword" class="sr-only">Password</label>
          <input type="password" id="inputPassword" class="form-control" placeholder="Password" required>
          <button class="btn btn-lg btn-primary btn-block" type="submit" id="loginBtn">Sign in</button>
        </form>
      </div>
      <div class="control">
        <table class="table table-striped">
          <thead><tr>
            <th colspan="3">Power</th>
          </tr></thead>
          <tbody>
            <tr>
              <td>Water Pump</td>
              <!-- the water pump is set on "normally closed", so we reverse it here -->
              <td><button class="btn btn-default" onClick="relay(1,0);">On</button><button class="btn btn-default" onClick="relay(1,1);">Off</button></td>
              <td><select id="r1starthour"></select> to <select id="r1endhour"></select>  All Day <input type="checkbox" id="r1allday" /></td>
            </tr>
            <tr>
              <td>Grow Bed #1</td>
              <td><button class="btn btn-default" onClick="relay(2,1);">On</button><button class="btn btn-default" onClick="relay(2,0);">Off</button></td>
              <td><select id="r2starthour"></select> to <select id="r2endhour"></select>  All Day <input type="checkbox" id="r2allday" /></td>
            </tr>
            <tr>
              <td>Grow Bed #2</td>
              <td><button class="btn btn-default" onClick="relay(3,1);">On</button><button class="btn btn-default" onClick="relay(3,0);">Off</button></td>
              <td><select id="r3starthour"></select> to <select id="r3endhour"></select>  All Day <input type="checkbox" id="r3allday" /></td>
            </tr>
            <tr>
              <td>Grow Bed #3</td>
              <td><button class="btn btn-default" onClick="relay(4,1);">On</button><button class="btn btn-default" onClick="relay(4,0);">Off</button></td>
              <td><select id="r4starthour"></select> to <select id="r4endhour"></select>  All Day <input type="checkbox" id="r4allday" /></td>
            </tr>
            <tr>
              <td>Grow Bed #4</td>
              <td><button class="btn btn-default" onClick="relay(5,1);">On</button><button class="btn btn-default" onClick="relay(5,0);">Off</button></td>
              <td><select id="r5starthour"></select> to <select id="r5endhour"></select>  All Day <input type="checkbox" id="r5allday" /></td>
            </tr>
            <tr>
              <td>Grow Bed #5</td>
              <td><button class="btn btn-default" onClick="relay(6,1);">On</button><button class="btn btn-default" onClick="relay(6,0);">Off</button></td>
              <td><select id="r6starthour"></select> to <select id="r6endhour"></select>  All Day <input type="checkbox" id="r6allday" /></td>
            </tr>
            <tr>
              <td>Koi Pond</td>
              <td><button class="btn btn-default" onClick="relay(7,1);">On</button><button class="btn btn-default" onClick="relay(7,0);">Off</button></td>
              <td><select id="r7starthour"></select> to <select id="r7endhour"></select>  All Day <input type="checkbox" id="r7allday" /></td>
            </tr>
            <tr>
              <td colspan="3"><span class="pull-right"><button class="btn btn-default">Update Changes</button></span></td>
            </tr>
          </tbody>
        </table>
        <hr />
        <form class="form-inline">
          <div class="form-group">
            <label class="sr-only" for="changeAdminPassword">Change Admin Password</label>
            <input type="password" class="form-control" id="changeAdminPassword" placeholder="Change Admin Password">
          </div>
          <button type="submit" class="btn btn-default" id="passwordAdminBtn">Update</button>
        </form>
        <hr />
        <form class="form-inline">
          <div class="form-group">
            <label class="sr-only" for="changeMonitorPassword">Change Monitor Password</label>
            <input type="password" class="form-control" id="changeMonitorPassword" placeholder="Change Monitor Password">
          </div>
          <button type="submit" class="btn btn-default" id="passwordMonitorBtn">Update</button>
        </form>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script>
var password;

$('#loginBtn').click(function(e){
  e.preventDefault();
  password = $('#inputPassword')[0].value;
  $.get("/auth/"+password).done(function(){
    $('.login').hide();
    $('.control').show();
  }).fail(function() {
    console.log('Access denied');
    $('.alertPW').show();
  });
});

$('#passwordAdminBtn').click(function(e){
  e.preventDefault();
  $.post('/admin/password', { type: 'admin', passwordOld: password, passwordNew: $('#changeAdminPassword')[0].value } );
  $('#changeAdminPassword')[0].value = null;
});

$('#passwordMonitorBtn').click(function(e){
  e.preventDefault();
  $.post('/admin/password', { type: 'monitor', passwordOld: password, passwordNew: $('#changeMonitorPassword')[0].value } );
  $('#changeMonitorPassword')[0].value = null;
});

function relay(r, s) {
  $.get('/relay/'+r+'/'+s+'/'+password);
}

function populateOptions(field, selected) {
  $.each(new Array(24), function(i, v) {
    $(field).append($('<option>', {value: i, text: i+':00', selected: (i==selected)?true:false}));
  });
}

$.get("/admin/relays", function(resultset){
  $.each(resultset, function(i,r) {
    if (r['allDay']) {
      $('#r'+r['relay']+'allday').prop('checked', true);
      populateOptions('#r'+r['relay']+'starthour', 0);
      populateOptions('#r'+r['relay']+'endhour', 0);
      $('#r'+r['relay']+'starthour').prop('disabled', true);
      $('#r'+r['relay']+'endhour').prop('disabled', true);
    } else {
      populateOptions('#r'+r['relay']+'starthour', r['timeOn']);
      populateOptions('#r'+r['relay']+'endhour', r['timeOff']);
    }
  });
});

$('#r1allday').click(function() {
  $('#r1starthour').val(0);
  $('#r1endhour').val(0);
  $('#r1starthour').prop('disabled', true);
  $('#r1endhour').prop('disabled', true);
});
$('#r2allday').click(function() {
  $('#r2starthour').val(0);
  $('#r2endhour').val(0);
  $('#r2starthour').prop('disabled', true);
  $('#r2endhour').prop('disabled', true);
});
$('#r3allday').click(function() {
  $('#r3starthour').val(0);
  $('#r3endhour').val(0);
});
$('#r4allday').click(function() {
  $('#r4starthour').val(0);
  $('#r4endhour').val(0);
});
$('#r5allday').click(function() {
  $('#r5starthour').val(0);
  $('#r5endhour').val(0);
});
$('#r6allday').click(function() {
  $('#r6starthour').val(0);
  $('#r6endhour').val(0);
});
$('#r7allday').click(function() {
  $('#r7starthour').val(0);
  $('#r7endhour').val(0);
});
    </script>
  </body>
</html>
